
{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Vocabulary Learning</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 30px;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 20px;
        }
        
        .dashboard {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            padding: 20px;
            min-height: 500px;
            position: sticky;
            top: 20px;
        }
        
        .right-panel {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            padding: 20px;
            min-height: 500px;
            position: sticky;
            top: 20px;
        }
        
        .dashboard h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 20px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .progress-section {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .progress-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .completion-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .completion-stats {
            font-size: 14px;
        }
        
        .progress-bar-container {
            background-color: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .accuracy-bar {
            background-color: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .accuracy-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .recent-words {
            margin-top: 20px;
        }
        
        .recent-words h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .word-correct {
            background-color: #d4edda;
            color: #155724;
        }
        
        .word-incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .word-retry {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .streak-badge {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: #333;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.2s ease;
        }
        
        .audio-controls {
            background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
            border-radius: 10px;
            padding: 12px;
            margin: 12px 0;
            color: white;
            text-align: center;
        }
        
        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active {
            background: rgba(255, 255, 255, 0.6);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }
        
        .audio-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        .audio-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .audio-btn.recording {
            background: #dc3545;
            border-color: #dc3545;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .listening-indicator {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            font-size: 28px;
            margin: 5px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.25);
        }
        
        .listening-indicator.listening {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.35);
        }
        
        .listening-indicator.waiting {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.35);
        }
        
        .audio-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.08) 0%, rgba(32, 201, 151, 0.08) 100%);
            border-radius: 12px;
            border: 1px solid rgba(40, 167, 69, 0.2);
            transition: all 0.3s ease;
        }
        
        .audio-input-container:hover {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.12) 0%, rgba(32, 201, 151, 0.12) 100%);
            border-color: rgba(40, 167, 69, 0.3);
        }
        
        .audio-status-text {
            font-size: 13px;
            color: #28a745;
            text-align: center;
            font-weight: 500;
            margin-top: 5px;
        }        .completion-screen {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        
        .completion-screen h2 {
            margin: 0 0 20px 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .completion-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .completion-actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .completion-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .completion-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        #level-selector {
            margin-bottom: 20px;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }
        
        .card-container {
            perspective: 1000px;
            width: 400px;
            min-height: 320px;
        }
        
        .card {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            width: 100%;
            max-width: 500px;
            min-height: 350px;
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            transition: transform 0.6s ease-in-out, opacity 0.3s ease-in-out;
            margin: 0 auto;
        }
        
        .card.flipped {
            transform: scale(0.95) rotateX(10deg);
            opacity: 0.8;
        }
        
        .card h3 {
            margin: 0 0 25px 0;
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }
        
        .card input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        .card input[type="text"]:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .umlaut-buttons {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .umlaut-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .umlaut-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .umlaut-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .submit-section {
            margin-top: 10px;
        }
        
        .card button[type="submit"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .card button[type="submit"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .card button[type="submit"]:active {
            transform: translateY(0);
        }
        
        .retry-mode {
            background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%);
            border: 2px solid #ffd60a;
        }
        
        .retry-mode h3 {
            color: #856404;
        }
        
        .message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            min-height: 20px;
            transition: all 0.3s ease;
        }
        
        .message.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.correction_submitted {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .csv-update-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .csv-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .csv-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .correction-interface {
            margin-top: 15px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }
        
        .correction-interface h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            text-align: center;
        }
        
        .correction-fields {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .correction-field {
            display: flex;
            flex-direction: column;
        }
        
        .correction-field label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .correction-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .correction-input:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }
        
        .current-values {
            background-color: #fff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        .current-values h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .current-value {
            font-size: 14px;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .correction-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .correction-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .accept-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .accept-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .suggest-btn {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }
        
        .suggest-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        /* Difficulty marking styles */
        .difficulty-controls {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .difficulty-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .easy-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .easy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .hard-btn {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .hard-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        /* Feature controls styling */
        .feature-controls {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item:last-child {
            margin-bottom: 0;
        }
        
        .card button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .card button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .card button:active {
            transform: translateY(0);
        }
        
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            min-height: 20px;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Metric cards */
        .metric-card {
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            text-align: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .metric-label {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        /* Streak display */
        .streak-display {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
            text-align: center;
        }
        
        .streak-bar {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* Recent words */
        .recent-words h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            text-align: center;
        }
        
        /* Reset button */
        .reset-btn {
            width: 100%;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }
        
        /* Completion screen */
        .completion-screen {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        
        .completion-btn {
            display: inline-block;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .completion-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        /* Card and form styles */
        .card-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            width: 100%;
            max-width: 500px;
            transition: all 0.3s ease;
        }
        
        .card.flipped {
            transform: rotateY(5deg);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }
        
        .form-content h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .card input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }
        
        .card input[type="text"]:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .umlaut-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .umlaut-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .umlaut-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        
        #level-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        
        #level-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Left Panel: Dashboard -->
    <div class="dashboard">
        <h3>üìä Progress Tracking</h3>
        
        <div class="progress-section">
            <h4>üéØ Level Progress</h4>
            <div class="completion-progress">
                <span id="completion-count">{{ completed_words or 0 }} / {{ total_words or 0 }} words completed</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="completion-progress-bar" style="width: 0%"></div>
            </div>
            <div class="completion-stats">
                <span>Selected Levels: </span><span id="current-level">{{ levels_display or (selected_levels|join(', ')) or 'A1.1' }}</span>
            </div>
        </div>
        
        <div class="metric-card" style="background: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);">
            <div class="metric-value" id="words-practiced">15</div>
            <div class="metric-label">WORDS PRACTICED</div>
        </div>
        
        <div class="metric-card" style="background: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);">
            <div class="metric-value" id="accuracy-rate">80%</div>
            <div class="metric-label">ACCURACY</div>
        </div>
        
        <div class="streak-display">
            <div class="streak-bar" id="streak-bar">
                <span class="streak-text">üî• Current Streak: <span id="current-streak">1</span></span>
            </div>
        </div>
    </div>

    <!-- Center Panel: Main Content -->
    {% if completed %}
    <div class="main-content">
        <div class="completion-screen">
            <h2>üéâ Congratulations!</h2>
            <p style="font-size: 18px; margin-bottom: 25px;">You've successfully completed all words in <strong>{{ level }}</strong>!</p>
            
            <div class="completion-stats">
                <h3 style="margin: 0 0 15px 0;">üìä Level Stats</h3>
                <p style="margin: 5px 0; font-size: 16px;"><strong>Total Words:</strong> {{ total_words }}</p>
                <p style="margin: 5px 0; font-size: 16px;"><strong>Level:</strong> {{ level }}</p>
                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">All words have been practiced and mastered!</p>
            </div>
            
            <div class="completion-actions">
                <a href="?level={{ level }}" class="completion-btn" onclick="resetLevelProgress()">
                    üîÑ Practice Again
                </a>
                <select id="next-level-select" class="completion-btn" style="background: rgba(255,255,255,0.3);" onchange="goToLevel(this.value)">
                    <option value="">Choose Next Level</option>
                    {% for option in level_options %}
                        {% if option != level %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    
    <script>
        function resetLevelProgress() {
            // Clear completion tracking for this level

            const currentLevel = document.getElementById('current-level').textContent;
            
            // Call backend to reset server-side progress
            fetch(`/vocab/${currentLevel}/reset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear localStorage completion data for this level
                    localStorage.removeItem('completed_' + currentLevel);
                    // Reload page to reset the session
                    window.location.reload();
                } else {
                    console.error('Error resetting level progress:', data.message);
                    alert('Error resetting progress: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error resetting level progress:', error);
                alert('Error resetting progress. Please try again.');
            });
        }
        
        function goToLevel(newLevel) {
            if (newLevel) {
                // Preserve all toggle states when changing level from completion screen
                const audioParam = audioMode ? '&audio=true' : '';
                const difficultParam = difficultOnlyMode ? '&difficult_only=true' : '';
                const articlesParam = articlesMandatoryMode ? '&articles_mandatory=true' : '';
                const minIncorrectCount = document.getElementById('incorrect-count-input') ? 
                    document.getElementById('incorrect-count-input').value.trim() : '';
                const incorrectCountParam = minIncorrectCount ? '&min_incorrect_count=' + encodeURIComponent(minIncorrectCount) : '';
                window.location.href = '?level=' + encodeURIComponent(newLevel) + audioParam + difficultParam + articlesParam + incorrectCountParam;
            }
        }
    </script>
    
    {% elif error %}
    <div class="main-content">
        <div class="card-container">
            <div class="card" style="background-color: #f8d7da; color: #721c24;">
                <h3>‚ö†Ô∏è Error</h3>
                <p>{{ error }}</p>
                <a href="?level=A1.1" style="color: #721c24;">‚Üê Back to A1.1</a>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="main-content">
        <div id="level-selector">
            <label for="level-select">Choose Levels: </label>
            <select id="level-select" multiple size="6" style="min-width: 120px;">
                {% for option in level_options %}
                    <option value="{{ option }}" 
                        {% if selected_levels and option in selected_levels %}selected{% endif %}>
                        {{ option }}
                    </option>
                {% endfor %}
            </select>
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                Hold Ctrl/Cmd to select multiple levels
            </div>
        </div>
        
        <div class="card-container">
            <div class="card" id="vocab-card">
                <form id="vocab-form">
                    <div class="form-content">
                        <h3 id="question-text">Translate: <span id="english-word">{{ english_word }}</span></h3>
                        
                        <input type="hidden" name="correct_deutsch" value="{{ correct_deutsch }}">
                        <input type="hidden" name="artikel" value="{{ artikel }}">
                        <input type="hidden" name="beispielsatz" value="{{ beispielsatz }}">
                        <input type="hidden" name="word_level" value="{{ word_level }}">
                        {% for level in selected_levels %}
                            <input type="hidden" name="levels" value="{{ level }}">
                        {% endfor %}
                        <input type="hidden" name="is_retry" value="false" id="retry-flag">
                        <input type="hidden" name="is_correction" value="false" id="correction-flag">
                        <input type="hidden" name="english_word" value="{{ english_word }}">
                        <input type="hidden" name="articles_mandatory" value="{{ 'true' if articles_mandatory else 'false' }}">
                        <input type="hidden" name="min_incorrect_count" value="{{ min_incorrect_count if min_incorrect_count is not none else '' }}">>
                        
                        <input type="text" name="user_input" id="user-input" placeholder="Type the German translation..." autocomplete="off" autofocus>
                        
                        <!-- Difficulty marking controls (shown before submitting) -->
                        <div class="difficulty-controls" id="pre-submit-difficulty" style="display: none; margin: 15px 0;">
                            <p style="font-size: 14px; margin-bottom: 10px; color: #666;">Mark difficulty level for this word:</p>
                            <div class="difficulty-buttons">
                                <button type="button" class="difficulty-btn easy-btn" onclick="markPreDifficulty(false)">
                                    üòä Easy
                                </button>
                                <button type="button" class="difficulty-btn hard-btn" onclick="markPreDifficulty(true)">
                                    üî• Difficult
                                </button>
                            </div>
                        </div>
                        
                        <div class="umlaut-buttons">
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√§')" title="Insert √§">√§</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√∂')" title="Insert √∂">√∂</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√º')" title="Insert √º">√º</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√Ñ')" title="Insert √Ñ">√Ñ</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√ñ')" title="Insert √ñ">√ñ</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√ú')" title="Insert √ú">√ú</button>
                            <button type="button" class="umlaut-btn" onclick="insertUmlaut('√ü')" title="Insert √ü">√ü</button>
                        </div>
                    </div>
                    
                    <div class="submit-section">
                        <button type="submit">Submit</button>
                        <div class="message" id="response-message"></div>
                        
                        <!-- Difficulty marking buttons (shown after correct answers) -->
                        <div class="difficulty-controls" id="difficulty-controls" style="display: none; margin-top: 15px;">
                            <p style="font-size: 14px; margin-bottom: 10px; color: #666;">Was this word difficult?</p>
                            <div class="difficulty-buttons">
                                <button type="button" class="difficulty-btn easy-btn" onclick="markDifficulty(false)">
                                    üòä Easy
                                </button>
                                <button type="button" class="difficulty-btn hard-btn" onclick="markDifficulty(true)">
                                    üî• Difficult
                                </button>
                            </div>
                        </div>
                        <div class="correction-interface" id="correction-interface" style="display: none;">
                            <h4>ÔøΩÔ∏è Edit Vocabulary Entry</h4>
                            
                            <div class="current-values">
                                <h5>Current Database Values:</h5>
                                <div class="current-value"><strong>English:</strong> <span id="current-english"></span></div>
                                <div class="current-value"><strong>German:</strong> <span id="current-german"></span></div>
                                <div class="current-value"><strong>Artikel:</strong> <span id="current-artikel"></span></div>
                                <div class="current-value"><strong>Beispielsatz:</strong> <span id="current-beispielsatz"></span></div>
                            </div>
                            
                            <div class="correction-fields">
                                <div class="correction-field">
                                    <label for="correction-english">English Translation</label>
                                    <input type="text" class="correction-input" id="correction-english" 
                                           placeholder="Enter the English meaning...">
                                </div>
                                
                                <div class="correction-field">
                                    <label for="correction-german">German Word</label>
                                    <input type="text" class="correction-input" id="correction-german" 
                                           placeholder="Enter the German word...">
                                </div>
                                
                                <div class="correction-field">
                                    <label for="correction-artikel">Artikel (der/die/das)</label>
                                    <select class="correction-input" id="correction-artikel">
                                        <option value="">Select artikel...</option>
                                        <option value="der">der (masculine)</option>
                                        <option value="die">die (feminine)</option>
                                        <option value="das">das (neuter)</option>
                                        <option value="">No artikel</option>
                                    </select>
                                </div>
                                
                                <div class="correction-field">
                                    <label for="correction-beispielsatz">Beispielsatz (Example Sentence)</label>
                                    <textarea class="correction-input" id="correction-beispielsatz" 
                                              rows="3" placeholder="Enter an example sentence... (can be left empty)"></textarea>
                                </div>
                            </div>
                            
                            <div class="correction-buttons">
                                <button type="button" class="correction-btn accept-btn" onclick="acceptDatabaseAnswer()">
                                    Keep Original
                                </button>
                                <button type="button" class="correction-btn suggest-btn" onclick="submitFullCorrection()">
                                    Submit Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    
    
    <!-- Right Panel: Controls & Stats -->
    <div class="right-panel">
        <h3>üéÆ Controls & History</h3>
        
        <div class="audio-controls">
            <div class="mode-toggle">
                <span>üìù Text</span>
                <div class="toggle-switch" id="audio-mode-toggle" onclick="toggleAudioMode()">
                    <div class="toggle-slider"></div>
                </div>
                <span>üéôÔ∏è Audio</span>
            </div>
            <div id="audio-status" style="font-size: 12px; opacity: 0.8;">
                Click to enable audio mode for speaking practice
            </div>

            <div class="control-item">
                <div class="mode-toggle">
                    <span>üåü All</span>
                    <div class="toggle-switch" id="difficult-mode-toggle" onclick="toggleDifficultMode()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span>üî• Difficult</span>
                </div>
            </div>
            
            <div class="control-item">
                <div class="mode-toggle">
                    <span>üìù No Articles</span>
                    <div class="toggle-switch" id="articles-toggle" onclick="toggleArticlesMandatory()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span>‚ö° Articles</span>
                </div>
            </div>
            
            <div class="control-item">
                <div class="incorrect-count-filter" style="text-align: center; margin-top: 10px;">
                    <label for="incorrect-count-input" style="font-size: 12px; color: white; display: block; margin-bottom: 5px;">
                        üî• Min. Incorrect Count
                    </label>
                    <input type="number" id="incorrect-count-input" min="0" max="50" 
                           style="width: 60px; padding: 4px 6px; border: 1px solid rgba(255,255,255,0.3); 
                                  border-radius: 4px; font-size: 12px; text-align: center; background: rgba(255,255,255,0.1); color: white;"
                           placeholder="0" value="{{ min_incorrect_count if min_incorrect_count is not none else '' }}"
                           onchange="applyIncorrectCountFilter()">
                    <div style="font-size: 10px; color: rgba(255,255,255,0.8); margin-top: 2px;">
                        Leave empty for all words
                    </div>
                </div>
            </div>

        </div>
        
        <div class="metric-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="metric-value" id="correct-count">0</div>
            <div class="metric-label">CORRECT ANSWERS</div>
        </div>
        
        <div class="metric-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
            <div class="metric-value" id="incorrect-count">0</div>
            <div class="metric-label">NEEDS PRACTICE</div>
        </div>
        
        <div class="recent-words">
            <h4>üìù Recent Words</h4>
            <div id="recent-words-list">
                <div style="text-align: center; color: #6c757d; font-size: 14px;">Start practicing to see your progress!</div>
            </div>
        </div>
        
        <button class="reset-btn" onclick="syncDashboardWithServer()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); margin-bottom: 10px;">
            üîÑ Sync with Server
        </button>
        
        <button class="reset-btn" onclick="resetProgress()">Reset Progress</button>
    </div>
    
    {% endif %}

    <script>
        // Performance tracking variables
        let performanceData = {
            totalWords: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            currentStreak: 0,
            bestStreak: 0,
            recentWords: [],
            wordsToday: 0,
            lastSessionDate: null
        };
        
        // Audio functionality variables
        let audioMode = false;
        let speechSynthesis = window.speechSynthesis;
        let speechRecognition = null;
        let isListening = false;
        let englishVoice = null;
        let germanVoice = null;
        
        // Feature toggle variables (mimic audioMode behavior)
        let difficultOnlyMode = false;
        let articlesMandatoryMode = false;
        
        // Initialize speech recognition if available
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            speechRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
            speechRecognition.lang = 'de-DE';
        }
        
        // Initialize voices for text-to-speech
        function initializeVoices() {
            const voices = speechSynthesis.getVoices();
            
            // Find English voice (prefer US or UK English)
            englishVoice = voices.find(voice => 
                voice.lang.startsWith('en-') && (voice.lang.includes('US') || voice.lang.includes('GB'))
            ) || voices.find(voice => voice.lang.startsWith('en-'));
            
            // Find German voice
            germanVoice = voices.find(voice => voice.lang.startsWith('de-'));
            
            console.log('Available voices initialized:', {
                english: englishVoice ? englishVoice.name : 'None',
                german: germanVoice ? germanVoice.name : 'None'
            });
        }
        
        // Toggle audio mode
        function toggleAudioMode() {
            audioMode = !audioMode;
            const toggle = document.getElementById('audio-mode-toggle');
            const status = document.getElementById('audio-status');
            
            if (audioMode) {
                toggle.classList.add('active');
                if (speechRecognition && speechSynthesis) {
                    status.textContent = 'üéôÔ∏è Audio mode enabled - speak your German answers!';
                    status.style.color = '#28a745';
                    
                    // Initialize voices
                    initializeVoices();
                    
                    // Update the form interface for audio mode
                    updateFormForAudioMode();
                } else {
                    status.textContent = '‚ùå Audio not supported in this browser';
                    status.style.color = '#dc3545';
                    audioMode = false;
                    toggle.classList.remove('active');
                }
            } else {
                toggle.classList.remove('active');
                status.textContent = 'Click to enable audio mode for speaking practice';
                status.style.color = 'inherit';
                
                // Restore text mode
                updateFormForTextMode();
            }
        }
        
        // Speak text using text-to-speech
        function speakText(text, language = 'en') {
            if (!speechSynthesis) return;
            
            // Stop any current speech
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (language === 'en' && englishVoice) {
                utterance.voice = englishVoice;
            } else if (language === 'de' && germanVoice) {
                utterance.voice = germanVoice;
            }
            
            utterance.rate = 0.8; // Slightly slower for learning
            utterance.pitch = 1;
            
            speechSynthesis.speak(utterance);
            
            return new Promise((resolve) => {
                utterance.onend = resolve;
                utterance.onerror = resolve;
            });
        }
        
        // Update form interface for audio mode
        function updateFormForAudioMode() {
            const userInput = document.getElementById('user-input');
            const submitButton = document.querySelector('button[type="submit"]');
            const questionText = document.getElementById('question-text');
            
            if (userInput && submitButton) {
                // Hide text input and submit button
                userInput.style.display = 'none';
                submitButton.style.display = 'none';
                
                // Create audio input container if it doesn't exist
                let audioContainer = document.getElementById('audio-input-container');
                if (!audioContainer) {
                    audioContainer = document.createElement('div');
                    audioContainer.id = 'audio-input-container';
                    audioContainer.className = 'audio-input-container';
                    
                    // Create listening indicator (no button needed)
                    const listeningIndicator = document.createElement('div');
                    listeningIndicator.id = 'listening-indicator';
                    listeningIndicator.className = 'listening-indicator';
                    listeningIndicator.innerHTML = 'üé§';
                    
                    // Create status text
                    const statusText = document.createElement('div');
                    statusText.id = 'audio-status-text';
                    statusText.className = 'audio-status-text';
                    statusText.textContent = 'Listening for your German answer...';
                    
                    audioContainer.appendChild(listeningIndicator);
                    audioContainer.appendChild(statusText);
                    
                    // Insert after the umlaut buttons
                    const umlautButtons = document.querySelector('.umlaut-buttons');
                    if (umlautButtons) {
                        umlautButtons.parentNode.insertBefore(audioContainer, umlautButtons.nextSibling);
                    } else {
                        userInput.parentNode.insertBefore(audioContainer, userInput.nextSibling);
                    }
                }
                audioContainer.style.display = 'flex';
                
                // Automatically speak the English word when in audio mode
                const englishWord = questionText ? questionText.textContent.replace('What is ', '').replace(' in German?', '').trim() : '';
                if (englishWord) {
                    setTimeout(() => {
                        speakText(englishWord, 'en').then(() => {
                            // Start auto-listening after speaking the question
                            setTimeout(() => {
                                startAutoListening();
                            }, 1000);
                        });
                    }, 800);
                }
            }
        }
        
        // Update form interface for text mode
        function updateFormForTextMode() {
            const userInput = document.getElementById('user-input');
            const submitButton = document.querySelector('button[type="submit"]'); // Changed from input to button
            const audioContainer = document.getElementById('audio-input-container');
            
            console.log('Updating for text mode:', { userInput, submitButton, audioContainer }); // Debug log
            
            if (userInput && submitButton) {
                // Show text input and submit button
                userInput.style.display = 'block';
                submitButton.style.display = 'block';
                
                // Hide audio container
                if (audioContainer) {
                    audioContainer.style.display = 'none';
                }
            }
        }
        
        // Start auto-listening (no button click required)
        function startAutoListening() {
            if (!speechRecognition || isListening) return;
            
            const indicator = document.getElementById('listening-indicator');
            const userInput = document.getElementById('user-input');
            const statusText = document.getElementById('audio-status-text');
            
            if (indicator) {
                indicator.classList.add('listening');
                indicator.innerHTML = 'üî¥';
            }
            if (statusText) {
                statusText.textContent = 'üéôÔ∏è Listening... speak your German answer now!';
                statusText.style.color = '#dc3545';
            }
            isListening = true;
            
            speechRecognition.start();
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Speech recognition result:', transcript);
                
                // Put the recognized text into the input field
                userInput.value = transcript;
                
                // Show what was recognized
                if (statusText) {
                    statusText.textContent = `Recognized: "${transcript}" - submitting...`;
                    statusText.style.color = '#28a745';
                }
                
                // Automatically submit the form
                setTimeout(() => {
                    document.getElementById('vocab-form').dispatchEvent(new Event('submit'));
                }, 800);
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopAutoListening();
                if (statusText) {
                    statusText.textContent = 'Speech recognition failed. Restarting in 3 seconds...';
                    statusText.style.color = '#dc3545';
                }
                // Auto-restart listening after error
                setTimeout(() => {
                    if (audioMode) {
                        startAutoListening();
                    }
                }, 3000);
            };
            
            speechRecognition.onend = function() {
                if (isListening && audioMode) {
                    // Restart listening if we're still in audio mode and no result was captured
                    setTimeout(() => {
                        if (audioMode && !userInput.value) {
                            startAutoListening();
                        }
                    }, 1000);
                }
                stopAutoListening();
            };
            
            // Auto-restart after 8 seconds of no speech
            setTimeout(() => {
                if (isListening && audioMode) {
                    speechRecognition.stop();
                    if (statusText) {
                        statusText.textContent = 'No speech detected. Restarting...';
                        statusText.style.color = '#ffc107';
                    }
                }
            }, 8000);
        }
        
        // Stop auto-listening
        function stopAutoListening() {
            const indicator = document.getElementById('listening-indicator');
            const statusText = document.getElementById('audio-status-text');
            
            if (indicator) {
                indicator.classList.remove('listening');
                indicator.innerHTML = 'üé§';
            }
            
            if (statusText && isListening && audioMode) {
                statusText.textContent = 'Listening for your German answer...';
                statusText.style.color = '#28a745';
            }
            
            isListening = false;
        }

        // Start listening for speech (legacy function for compatibility)
        function startListening() {
            if (!speechRecognition || isListening) return;
            
            const micButton = document.getElementById('mic-button');
            const userInput = document.getElementById('user-input');
            const statusText = document.getElementById('audio-status-text');
            
            micButton.classList.add('recording');
            micButton.innerHTML = 'üî¥';
            micButton.title = 'Listening... speak now!';
            if (statusText) {
                statusText.textContent = 'üéôÔ∏è Listening... speak your German answer now!';
                statusText.style.color = '#dc3545';
            }
            isListening = true;
            
            speechRecognition.start();
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Speech recognition result:', transcript);
                
                // Put the recognized text into the input field
                userInput.value = transcript;
                
                // Show what was recognized
                if (statusText) {
                    statusText.textContent = `Recognized: "${transcript}" - submitting...`;
                    statusText.style.color = '#28a745';
                }
                
                // Automatically submit the form
                setTimeout(() => {
                    document.getElementById('vocab-form').dispatchEvent(new Event('submit'));
                }, 800);
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopListening();
                if (statusText) {
                    statusText.textContent = 'Speech recognition failed. Try again!';
                    statusText.style.color = '#dc3545';
                }
                setTimeout(() => {
                    if (statusText) {
                        statusText.textContent = 'Click üé§ and speak the German translation';
                        statusText.style.color = '#6c757d';
                    }
                }, 3000);
            };
            
            speechRecognition.onend = function() {
                stopListening();
            };
            
            // Auto-stop after 10 seconds
            setTimeout(() => {
                if (isListening) {
                    speechRecognition.stop();
                    if (statusText) {
                        statusText.textContent = 'Listening timeout. Click üé§ to try again.';
                        statusText.style.color = '#ffc107';
                    }
                }
            }, 10000);
        }
        
        // Stop listening for speech
        function stopListening() {
            const micButton = document.getElementById('mic-button');
            const statusText = document.getElementById('audio-status-text');
            
            if (micButton) {
                micButton.classList.remove('recording');
                micButton.innerHTML = 'üé§';
                micButton.title = 'Click to speak your German answer';
            }
            
            if (statusText && isListening) {
                statusText.textContent = 'Click üé§ and speak the German translation';
                statusText.style.color = '#6c757d';
            }
            
            isListening = false;
        }

        // Load performance data from localStorage
        function loadPerformanceData() {
            const saved = localStorage.getItem('deutschVocabProgress');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Check if it's a new day
                const today = new Date().toDateString();
                if (parsed.lastSessionDate !== today) {
                    parsed.wordsToday = 0;
                    parsed.lastSessionDate = today;
                }
                performanceData = { ...performanceData, ...parsed };
            }
            updateDashboard();
        }

        // Save performance data to localStorage
        function savePerformanceData() {
            performanceData.lastSessionDate = new Date().toDateString();
            localStorage.setItem('deutschVocabProgress', JSON.stringify(performanceData));
        }

        // Sync browser cache with server progress.json data
        function syncDashboardWithServer() {
            fetch('/vocab/dashboard-sync', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update local performance data with server data
                    performanceData = { ...performanceData, ...data.dashboard_data };
                    
                    // Save the synced data to localStorage
                    savePerformanceData();
                    
                    // Update dashboard display
                    updateDashboard();
                    
                    console.log('Dashboard synced with server progress.json');
                    
                    // Show success message to user
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'sync-message';
                    messageDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                        z-index: 1000;
                        font-weight: bold;
                        animation: slideInRight 0.3s ease-out;
                    `;
                    messageDiv.textContent = '‚úÖ Dashboard synced with progress data!';
                    document.body.appendChild(messageDiv);
                    
                    // Remove message after 3 seconds
                    setTimeout(() => {
                        messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => {
                            if (messageDiv.parentNode) {
                                messageDiv.parentNode.removeChild(messageDiv);
                            }
                        }, 300);
                    }, 3000);
                } else {
                    console.error('Failed to sync dashboard:', data.message);
                    alert('Failed to sync dashboard with server data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error syncing dashboard:', error);
                alert('Error syncing dashboard. Please try again.');
            });
        }

        // Update dashboard display
        function updateDashboard() {
            // Update words practiced (was total-words)
            const wordsElement = document.getElementById('words-practiced');
            if (wordsElement) {
                wordsElement.textContent = performanceData.totalWords;
            }
            
            // Update correct/incorrect counts
            const correctElement = document.getElementById('correct-count');
            if (correctElement) {
                correctElement.textContent = performanceData.correctAnswers;
            }
            
            const incorrectElement = document.getElementById('incorrect-count');
            if (incorrectElement) {
                incorrectElement.textContent = performanceData.incorrectAnswers;
            }
            
            // Update current streak
            const streakElement = document.getElementById('current-streak');
            if (streakElement) {
                streakElement.textContent = performanceData.currentStreak;
            }
            
            // Calculate and update accuracy
            const accuracy = performanceData.totalWords > 0 
                ? Math.round((performanceData.correctAnswers / performanceData.totalWords) * 100)
                : 0;
            
            const accuracyElement = document.getElementById('accuracy-rate');
            if (accuracyElement) {
                accuracyElement.textContent = accuracy + '%';
            }
            
            // Update completion progress bar
            const progressBarElement = document.getElementById('completion-progress-bar');
            if (progressBarElement) {
                progressBarElement.style.width = accuracy + '%';
            }
            
            // Update level progress
            updateLevelProgress();
            
            // Update recent words list
            updateRecentWordsList();
        }
        
        // Update browser state with corrected values
        function updateBrowserWithCorrection(metrics) {
            if (metrics.corrected_values) {
                const corrected = metrics.corrected_values;
                
                // Update hidden form fields with corrected values
                if (corrected.german && document.querySelector('input[name="correct_deutsch"]')) {
                    document.querySelector('input[name="correct_deutsch"]').value = corrected.german;
                }
                if (corrected.english && document.querySelector('input[name="english_word"]')) {
                    document.querySelector('input[name="english_word"]').value = corrected.english;
                }
                if (corrected.artikel !== undefined && document.querySelector('input[name="artikel"]')) {
                    document.querySelector('input[name="artikel"]').value = corrected.artikel || '';
                }
                
                console.log('Browser state updated with corrections:', corrected);
            }
        }

        // Update level progress display
        function updateLevelProgress() {
            // Get currently selected levels
            const selectedLevels = Array.from(document.getElementById('level-select').selectedOptions).map(option => option.value);
            if (selectedLevels.length === 0) return;
            
            // Build query parameters to match current filters
            const params = new URLSearchParams();
            selectedLevels.forEach(level => params.append('levels', level));
            
            // Add current filter states
            if (difficultOnlyMode) {
                params.append('difficult_only', 'true');
            }
            
            const minIncorrectInput = document.getElementById('incorrect-count-input');
            if (minIncorrectInput && minIncorrectInput.value.trim()) {
                params.append('min_incorrect_count', minIncorrectInput.value.trim());
            }
            
            fetch(`/vocab/progress?${params.toString()}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const completedCount = data.completed_words || 0;
                    const totalCount = data.total_words || 1;
                    const percentage = Math.round((completedCount / totalCount) * 100);
                    
                    // Update completion count display (left panel)
                    const completionElement = document.getElementById('completion-count');
                    if (completionElement) {
                        completionElement.textContent = `${completedCount} / ${totalCount} words completed`;
                    }
                    
                    // Update progress bar (left panel)
                    const progressBar = document.getElementById('completion-progress-bar');
                    if (progressBar) {
                        progressBar.style.width = percentage + '%';
                    }
                    
                    // Update current level display with filter info
                    const currentLevelElement = document.getElementById('current-level');
                    if (currentLevelElement) {
                        let displayText = data.levels.join(', ');
                        
                        // Add filter indicators
                        const filterIndicators = [];
                        if (data.filters.difficult_only) {
                            filterIndicators.push('üî• Difficult');
                        }
                        if (data.filters.min_incorrect_count && data.filters.min_incorrect_count > 0) {
                            filterIndicators.push(`üìä ${data.filters.min_incorrect_count}+ errors`);
                        }
                        
                        if (filterIndicators.length > 0) {
                            displayText += ` (${filterIndicators.join(', ')})`;
                        }
                        
                        currentLevelElement.textContent = displayText;
                    }
                }
            })
            .catch(error => console.error('Error updating level progress:', error));
        }

        // Update recent words list
        function updateRecentWordsList() {
            const container = document.getElementById('recent-words-list');
            if (performanceData.recentWords.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; font-size: 14px;">Start practicing to see your progress!</div>';
                return;
            }
            
            const recentHTML = performanceData.recentWords.slice(-5).reverse().map(word => {
                let className = 'word-correct';
                let icon = '‚úÖ';
                if (!word.correct && word.retry) {
                    className = 'word-retry';
                    icon = 'üîÑ';
                } else if (!word.correct) {
                    className = 'word-incorrect';
                    icon = '‚ùå';
                }
                
                return `
                    <div class="word-item ${className}">
                        <span><strong>${word.word}</strong> (${word.english})</span>
                        <span>${icon}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = recentHTML;
        }

        // Track performance metrics
        function trackPerformance(metrics) {
            performanceData.totalWords++;
            performanceData.wordsToday++;
            
            if (metrics.correct) {
                performanceData.correctAnswers++;
                performanceData.currentStreak++;
                if (performanceData.currentStreak > performanceData.bestStreak) {
                    performanceData.bestStreak = performanceData.currentStreak;
                }
            } else {
                performanceData.incorrectAnswers++;
                performanceData.currentStreak = 0;
            }
            
            // Add to recent words (keep last 10)
            const wordData = {
                word: metrics.word,
                english: metrics.english,
                correct: metrics.correct,
                retry: metrics.retry,
                timestamp: metrics.timestamp
            };
            
            performanceData.recentWords.push(wordData);
            if (performanceData.recentWords.length > 10) {
                performanceData.recentWords = performanceData.recentWords.slice(-10);
            }
            
            updateDashboard();
            savePerformanceData();
        }

        // Reset progress function
        function resetProgress() {
            if (confirm('Are you sure you want to reset all your progress? This cannot be undone.')) {
                // Call backend to reset server-side progress
                fetch('/vocab/reset-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Clear all localStorage data
                        localStorage.removeItem('deutschVocabProgress');
                        
                        // Clear any level-specific completion data
                        for (let key in localStorage) {
                            if (key.startsWith('completed_')) {
                                localStorage.removeItem(key);
                            }
                        }
                        
                        // Reset local performance data
                        performanceData = {
                            totalWords: 0,
                            correctAnswers: 0,
                            incorrectAnswers: 0,
                            currentStreak: 0,
                            bestStreak: 0,
                            recentWords: [],
                            wordsToday: 0,
                            lastSessionDate: null
                        };
                        
                        // Update both dashboard and level progress
                        updateDashboard();
                        updateLevelProgress();
                        
                        alert('All progress has been reset successfully!');
                    } else {
                        console.error('Error resetting progress:', data.message);
                        alert('Error resetting progress: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error resetting progress:', error);
                    alert('Error resetting progress. Please try again.');
                });
            }
        }

        // Handle correction submission
        function submitFullCorrection() {
            const correctedGerman = document.getElementById('correction-german').value.trim();
            const correctedEnglish = document.getElementById('correction-english').value.trim();
            const correctedArtikel = document.getElementById('correction-artikel').value.trim();
            const correctedBeispielsatz = document.getElementById('correction-beispielsatz').value.trim();
            
            // Check if at least one field has a value
            if (!correctedGerman && !correctedEnglish && !correctedArtikel && !correctedBeispielsatz) {
                alert('Please fill in at least one field to make a correction.');
                // Return focus to main input after alert
                document.getElementById('user-input').focus();
                return;
            }
            
            // Set correction flags and data
            document.getElementById('correction-flag').value = 'true';
            
            // Add hidden fields for the corrections if they don't exist
            let germanField = document.getElementById('corrected-german-field');
            if (!germanField) {
                germanField = document.createElement('input');
                germanField.type = 'hidden';
                germanField.name = 'corrected_german';
                germanField.id = 'corrected-german-field';
                document.getElementById('vocab-form').appendChild(germanField);
            }
            
            let englishField = document.getElementById('corrected-english-field');
            if (!englishField) {
                englishField = document.createElement('input');
                englishField.type = 'hidden';
                englishField.name = 'corrected_english';
                englishField.id = 'corrected-english-field';
                document.getElementById('vocab-form').appendChild(englishField);
            }
            
            let artikelField = document.getElementById('corrected-artikel-field');
            if (!artikelField) {
                artikelField = document.createElement('input');
                artikelField.type = 'hidden';
                artikelField.name = 'corrected_artikel';
                artikelField.id = 'corrected-artikel-field';
                document.getElementById('vocab-form').appendChild(artikelField);
            }
            
            let beispielsatzField = document.getElementById('corrected-beispielsatz-field');
            if (!beispielsatzField) {
                beispielsatzField = document.createElement('input');
                beispielsatzField.type = 'hidden';
                beispielsatzField.name = 'corrected_beispielsatz';
                beispielsatzField.id = 'corrected-beispielsatz-field';
                document.getElementById('vocab-form').appendChild(beispielsatzField);
            }
            
            // Set the values
            germanField.value = correctedGerman;
            englishField.value = correctedEnglish;
            artikelField.value = correctedArtikel;
            beispielsatzField.value = correctedBeispielsatz;
            
            // Submit the correction
            document.getElementById('vocab-form').dispatchEvent(new Event('submit'));
        }

        // Show/hide correction interface
        function showCorrectionInterface() {
            // Get current values
            const currentGerman = document.querySelector('input[name="correct_deutsch"]').value;
            const currentEnglish = document.querySelector('input[name="english_word"]').value;
            const currentArtikel = document.querySelector('input[name="artikel"]').value;
            const currentBeispielsatz = document.querySelector('input[name="beispielsatz"]').value;
            
            // Handle empty/None artikel properly
            const displayArtikel = currentArtikel && currentArtikel !== 'None' ? currentArtikel : '';
            const displayGermanFull = displayArtikel ? `${displayArtikel} ${currentGerman}` : currentGerman;
            const displayBeispielsatz = currentBeispielsatz || '(empty)';
            
            // Update current values display
            document.getElementById('current-german').textContent = displayGermanFull;
            document.getElementById('current-english').textContent = currentEnglish;
            document.getElementById('current-artikel').textContent = displayArtikel || 'None';
            document.getElementById('current-beispielsatz').textContent = displayBeispielsatz;
            
            // Pre-fill the correction fields with current values
            document.getElementById('correction-german').value = currentGerman;
            document.getElementById('correction-english').value = currentEnglish;
            document.getElementById('correction-artikel').value = displayArtikel; // Use empty string instead of 'None'
            document.getElementById('correction-beispielsatz').value = currentBeispielsatz;
            
            // Show the interface
            document.getElementById('correction-interface').style.display = 'block';
            // DON'T auto-focus on correction fields - keep focus on main input
        }

        function hideCorrectionInterface() {
            document.getElementById('correction-interface').style.display = 'none';
            
            // Clear the fields
            document.getElementById('correction-german').value = '';
            document.getElementById('correction-english').value = '';
            document.getElementById('correction-artikel').value = '';
            document.getElementById('correction-beispielsatz').value = '';
        }

        function insertUmlaut(char) {
            const inputField = document.getElementById('user-input');
            const cursorPos = inputField.selectionStart;
            const textBefore = inputField.value.substring(0, cursorPos);
            const textAfter = inputField.value.substring(inputField.selectionEnd, inputField.value.length);
            
            inputField.value = textBefore + char + textAfter;
            inputField.focus();
            inputField.setSelectionRange(cursorPos + 1, cursorPos + 1);
        }

        document.getElementById('vocab-form').onsubmit = function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Add pre-marked difficulty if set
            if (preMarkedDifficulty !== null) {
                formData.append('pre_difficulty', preMarkedDifficulty);
            }
            
            // Add toggle states
            formData.append('difficult_only', difficultOnlyMode);
            formData.append('articles_mandatory', articlesMandatoryMode);

            fetch("", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const messageElement = document.getElementById('response-message');
                const card = document.getElementById('vocab-card');
                const questionText = document.getElementById('question-text');
                const userInput = document.getElementById('user-input');
                const retryFlag = document.getElementById('retry-flag');
                const correctionFlag = document.getElementById('correction-flag');
                
                messageElement.innerText = data.message;
                messageElement.className = 'message ' + data.type;
                
                // Track performance if metrics are provided
                if (data.metrics) {
                    trackPerformance(data.metrics);
                }

                // Show example sentence (Beispielsatz) if provided by server
                if (data.beispielsatz) {
                    const exampleDiv = document.createElement('div');
                    exampleDiv.className = 'example-sentence';
                    exampleDiv.style.marginTop = '8px';
                    exampleDiv.style.fontStyle = 'italic';
                    exampleDiv.style.color = '#444';
                    exampleDiv.innerText = 'Beispielsatz: ' + data.beispielsatz;
                    messageElement.appendChild(exampleDiv);
                }
                
                if (data.type === 'success' || data.type === 'correction_submitted') {
                    // Hide correction interface
                    hideCorrectionInterface();
                    
                    // Hide pre-submit difficulty controls and reset state
                    document.getElementById('pre-submit-difficulty').style.display = 'none';
                    preMarkedDifficulty = null;
                    
                    // Reset difficulty button styles
                    const easyBtn = document.querySelector('#pre-submit-difficulty .easy-btn');
                    const hardBtn = document.querySelector('#pre-submit-difficulty .hard-btn');
                    if (easyBtn) {
                        easyBtn.style.backgroundColor = '';
                        easyBtn.style.color = '';
                    }
                    if (hardBtn) {
                        hardBtn.style.backgroundColor = '';
                        hardBtn.style.color = '';
                    }
                    
                    // Show difficulty controls for successful answers (not retries)
                    if (data.type === 'success' && data.metrics && !data.metrics.retry) {
                        setTimeout(() => {
                            document.getElementById('difficulty-controls').style.display = 'block';
                        }, 500);
                    }
                    
                    // Audio feedback for correct answers
                    if (audioMode && data.type === 'success' && data.metrics && data.metrics.word) {
                        // Speak the correct German word
                        const correctGerman = data.metrics.word;
                        const artikel = data.metrics.artikel || '';
                        const fullGermanWord = artikel ? `${artikel} ${correctGerman}` : correctGerman;
                        
                        setTimeout(() => {
                            speakText(fullGermanWord, 'de');
                        }, 500);
                    }
                    
                    // Show CSV update status if it's a correction
                    if (data.type === 'correction_submitted' && data.metrics && data.metrics.update_success !== undefined) {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'csv-update-status ' + (data.metrics.update_success ? 'csv-success' : 'csv-warning');
                        statusDiv.innerHTML = data.metrics.update_success 
                            ? '‚úÖ Database file updated successfully!' 
                            : '‚ö†Ô∏è Note: Changes logged but database file not updated';
                        messageElement.appendChild(statusDiv);
                        
                        // Update browser state with corrected values if correction was successful
                        if (data.metrics.update_success) {
                            updateBrowserWithCorrection(data.metrics);
                        }
                    }
                    
                    // Add flip animation without mirror effect
                    card.classList.add('flipped');
                    
                    // Create a smooth transition to the next word
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.9)';
                        
                        setTimeout(() => {
                            // Reset correction flags
                            correctionFlag.value = 'false';
                            
                            // Clean up any correction fields
                            const fieldsToRemove = ['corrected-german-field', 'corrected-english-field', 'corrected-artikel-field', 'corrected-beispielsatz-field'];
                            fieldsToRemove.forEach(id => {
                                const field = document.getElementById(id);
                                if (field) field.remove();
                            });
                            
                            // Reload with the same levels and preserve all toggle states
                            const selectedLevels = Array.from(document.getElementById('level-select').selectedOptions).map(option => option.value);
                            const audioParam = audioMode ? '&audio=true' : '';
                            const difficultParam = difficultOnlyMode ? '&difficult_only=true' : '';
                            const articlesParam = articlesMandatoryMode ? '&articles_mandatory=true' : '';
                            const minIncorrectCount = document.getElementById('incorrect-count-input') ? 
                                document.getElementById('incorrect-count-input').value.trim() : '';
                            const incorrectCountParam = minIncorrectCount ? '&min_incorrect_count=' + encodeURIComponent(minIncorrectCount) : '';
                            const levelsParam = selectedLevels.map(level => 'levels=' + encodeURIComponent(level)).join('&');
                            window.location.href = '?' + levelsParam + audioParam + difficultParam + articlesParam + incorrectCountParam;
                        }, 300);
                    }, 1200); // Longer delay to show the update status
                } else if (data.type === 'retry_with_correction') {
                    // Change to retry mode with correction option
                    card.classList.add('retry-mode');
                    questionText.innerHTML = 'Type the correct answer: <strong>' + data.artikel + ' ' + data.correct_answer + '</strong>';
                    userInput.value = '';
                    userInput.placeholder = 'Type the correct German word...';
                    retryFlag.value = 'true';
                    
                    // Show correction interface but keep focus on main input
                    showCorrectionInterface();
                    userInput.focus(); // Ensure focus stays on main input
                    
                    // Update hidden fields for retry
                    document.querySelector('input[name="correct_deutsch"]').value = data.correct_answer;
                    document.querySelector('input[name="artikel"]').value = data.artikel;
                    document.querySelector('input[name="english_word"]').value = data.english_word;
                } else if (data.type === 'error_with_correction') {
                    // Show correction interface for persistent errors but keep focus on main input
                    showCorrectionInterface();
                    userInput.focus(); // Ensure focus stays on main input
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const messageElement = document.getElementById('response-message');
                messageElement.innerText = 'An error occurred. Please try again.';
                messageElement.className = 'message error';
            });
        }

        document.getElementById('level-select').onchange = function() {
            const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
            if (selectedOptions.length === 0) {
                return; // Don't navigate if no levels selected
            }
            
            // Preserve all toggle states when changing levels
            const audioParam = audioMode ? '&audio=true' : '';
            const difficultParam = difficultOnlyMode ? '&difficult_only=true' : '';
            const articlesParam = articlesMandatoryMode ? '&articles_mandatory=true' : '';
            const minIncorrectCount = document.getElementById('incorrect-count-input') ? 
                document.getElementById('incorrect-count-input').value.trim() : '';
            const incorrectCountParam = minIncorrectCount ? '&min_incorrect_count=' + encodeURIComponent(minIncorrectCount) : '';
            const levelsParam = selectedOptions.map(level => 'levels=' + encodeURIComponent(level)).join('&');
            window.location.href = '?' + levelsParam + audioParam + difficultParam + articlesParam + incorrectCountParam;
        }

        // Initialize performance tracking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPerformanceData();
            
            // Initialize progress bar with server data
            const totalWords = {{ total_words or 0 }};
            const completedWords = {{ completed_words or 0 }};
            if (totalWords > 0) {
                const percentage = Math.round((completedWords / totalWords) * 100);
                const progressBar = document.getElementById('completion-progress-bar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
            }
            
            // Update level progress from server
            updateLevelProgress();
            
            // Initialize speech synthesis voices
            if (speechSynthesis) {
                speechSynthesis.onvoiceschanged = initializeVoices;
                initializeVoices(); // Call immediately in case voices are already loaded
            }
            
            // Check if auto-sync is needed (if localStorage data seems stale)
            const saved = localStorage.getItem('deutschVocabProgress');
            if (saved) {
                const parsed = JSON.parse(saved);
                const daysSinceLastSession = parsed.lastSessionDate ? 
                    Math.floor((new Date() - new Date(parsed.lastSessionDate)) / (1000 * 60 * 60 * 24)) : 999;
                
                // Auto-sync if last session was more than 1 day ago or if data seems corrupted
                if (daysSinceLastSession > 1 || !parsed.totalWords || parsed.totalWords < 0) {
                    console.log('Auto-syncing dashboard with server data...');
                    setTimeout(() => syncDashboardWithServer(), 1000);
                }
            } else {
                // No localStorage data exists, sync with server
                console.log('No dashboard data found, syncing with server...');
                setTimeout(() => syncDashboardWithServer(), 1000);
            }
            
            // Check if audio mode should be enabled from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('audio') === 'true') {
                setTimeout(() => {
                    toggleAudioMode();
                    // Start auto-listening after a delay to ensure everything is initialized
                    setTimeout(() => {
                        if (audioMode) {
                            startAutoListening();
                        }
                    }, 2000);
                }, 1000); // Wait for voices to be initialized
            }
            
            const inputField = document.querySelector('input[name="user_input"]');
            if (inputField) {
                inputField.focus();
            }
        });

        // Allow Enter key to work properly
        document.getElementById('user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('vocab-form').dispatchEvent(new Event('submit'));
            }
        });
        
        // Show difficulty controls when user starts typing
        document.getElementById('user-input').addEventListener('input', function(event) {
            showPreSubmitDifficulty();
        });

        // New functions for difficulty marking and toggles
        
        // Initialize toggle states from URL parameters
        function initializeToggles() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Initialize difficult mode toggle
            const difficultModeToggle = document.getElementById('difficult-mode-toggle');
            if (urlParams.get('difficult_only') === 'true') {
                difficultModeToggle.classList.add('active');
            }
            
            // Initialize articles mandatory toggle
            const articlesToggle = document.getElementById('articles-toggle');
            if (urlParams.get('articles_mandatory') === 'true') {
                articlesToggle.classList.add('active');
            }
        }
        
        // Toggle difficult words only mode
        function toggleDifficultMode() {
            difficultOnlyMode = !difficultOnlyMode;
            const toggle = document.getElementById('difficult-mode-toggle');
            
            if (difficultOnlyMode) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // Update progress immediately when filter changes
            updateLevelProgress();
            
            console.log('Difficult only mode:', difficultOnlyMode ? 'enabled' : 'disabled');
        }
        
        // Toggle articles mandatory mode
        function toggleArticlesMandatory() {
            articlesMandatoryMode = !articlesMandatoryMode;
            const toggle = document.getElementById('articles-toggle');
            
            if (articlesMandatoryMode) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // Update the hidden form field
            const articlesField = document.querySelector('input[name="articles_mandatory"]');
            if (articlesField) {
                articlesField.value = articlesMandatoryMode ? 'true' : 'false';
            }
            
            console.log('Articles mandatory mode:', articlesMandatoryMode ? 'enabled' : 'disabled');
        }
        
        // Mark word difficulty before submission
        let preMarkedDifficulty = null; // Store the difficulty marking
        
        function markPreDifficulty(isDifficult) {
            preMarkedDifficulty = isDifficult;
            
            // Visual feedback
            const easyBtn = document.querySelector('#pre-submit-difficulty .easy-btn');
            const hardBtn = document.querySelector('#pre-submit-difficulty .hard-btn');
            
            if (isDifficult) {
                hardBtn.style.backgroundColor = '#dc3545';
                hardBtn.style.color = 'white';
                easyBtn.style.backgroundColor = '';
                easyBtn.style.color = '';
            } else {
                easyBtn.style.backgroundColor = '#28a745';
                easyBtn.style.color = 'white';
                hardBtn.style.backgroundColor = '';
                hardBtn.style.color = '';
            }
            
            console.log('Pre-marked difficulty:', isDifficult ? 'hard' : 'easy');
        }
        
        // Show pre-submit difficulty controls after user starts typing
        function showPreSubmitDifficulty() {
            const userInput = document.getElementById('user-input');
            const difficultyControls = document.getElementById('pre-submit-difficulty');
            
            if (userInput.value.trim().length > 0 && difficultyControls.style.display === 'none') {
                difficultyControls.style.display = 'block';
            }
        }
        
        // Mark word difficulty (original function for post-submit, now unused)
        function markDifficulty(isDifficult) {
            const englishWord = document.querySelector('input[name="english_word"]').value;
            const deutsch = document.querySelector('input[name="correct_deutsch"]').value;
            const artikel = document.querySelector('input[name="artikel"]').value;
            const level = document.querySelector('input[name="level"]').value;
            
            fetch('/Deutsch_Vocab_html', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'mark_difficulty': 'true',
                    'english': englishWord,
                    'deutsch': deutsch,
                    'artikel': artikel,
                    'difficulty': isDifficult,
                    'level': level
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Difficulty marked:', data);
            })
            .catch(error => {
                console.error('Error marking difficulty:', error);
            });
        }
        
        // Initialize toggles on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize toggle states from backend
            {% if difficult_only %}
            difficultOnlyMode = true;
            document.getElementById('difficult-mode-toggle').classList.add('active');
            {% endif %}
            
            {% if articles_mandatory %}
            articlesMandatoryMode = true;
            document.getElementById('articles-toggle').classList.add('active');
            {% endif %}
        });

        // Apply incorrect count filter
        function applyIncorrectCountFilter() {
            // Update progress immediately when filter changes
            updateLevelProgress();
            
            const selectedLevels = Array.from(document.getElementById('level-select').selectedOptions).map(option => option.value);
            if (selectedLevels.length === 0) {
                return; // Don't navigate if no levels selected
            }
            
            const minIncorrectCount = document.getElementById('incorrect-count-input').value.trim();
            const audioParam = audioMode ? '&audio=true' : '';
            const difficultParam = difficultOnlyMode ? '&difficult_only=true' : '';
            const articlesParam = articlesMandatoryMode ? '&articles_mandatory=true' : '';
            const incorrectCountParam = minIncorrectCount ? '&min_incorrect_count=' + encodeURIComponent(minIncorrectCount) : '';
            const levelsParam = selectedLevels.map(level => 'levels=' + encodeURIComponent(level)).join('&');
            
            window.location.href = '?' + levelsParam + audioParam + difficultParam + articlesParam + incorrectCountParam;
        }
    </script>
</body>
</html>
{% endblock %}
